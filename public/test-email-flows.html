<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Flow Test Suite</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f7f7f5;
    }
    .test-scenario {
      background: white;
      border: 1px solid #e5e5e3;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .test-scenario h3 {
      margin: 0 0 8px 0;
      color: #0e1a2b;
    }
    .test-scenario p {
      margin: 4px 0;
      color: #666;
      font-size: 14px;
    }
    button {
      background: #7ef4c2;
      color: #0e1a2b;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    button:hover {
      background: #5dd4a8;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      margin-top: 8px;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    .status.pending {
      background: #fff3cd;
      color: #856404;
    }
    .summary {
      background: #0e1a2b;
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .summary h2 {
      margin: 0 0 12px 0;
    }
    .summary-stats {
      display: flex;
      gap: 24px;
      margin-top: 12px;
    }
    .stat {
      display: flex;
      flex-direction: column;
    }
    .stat-value {
      font-size: 24px;
      font-weight: 700;
    }
    .stat-label {
      font-size: 12px;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div class="summary">
    <h2>Email Flow Test Suite</h2>
    <p>This page tests all CTA paths by sending emails through the send-lead-email edge function.</p>
    <div class="summary-stats">
      <div class="stat">
        <div class="stat-value" id="total">0</div>
        <div class="stat-label">Total Tests</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="success">0</div>
        <div class="stat-label">Successful</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="failed">0</div>
        <div class="stat-label">Failed</div>
      </div>
    </div>
  </div>

  <div id="test-scenarios"></div>

  <script type="module">
    // Import Supabase client
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // Get Supabase credentials from environment or use defaults
    const SUPABASE_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:54321' 
      : 'https://your-project.supabase.co';
    const SUPABASE_ANON_KEY = 'your-anon-key'; // Replace with actual key

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const testScenarios = [
      {
        id: 1,
        name: "Main Page - Book Your Initial Consult (Bottom)",
        description: "User clicks 'Book Your Initial Consult' at bottom of main page",
        source: "initial-consult",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "CEO",
          selectedProgram: "not-sure",
          sessionData: {
            pagesVisited: ["/"],
            timeOnSite: 120,
            scrollDepth: 75,
          },
        },
      },
      {
        id: 2,
        name: "Navigation - Book Session (Top Nav)",
        description: "User clicks 'Book Session' button in top navigation",
        source: "navigation",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "Executive Director",
          selectedProgram: "not-sure",
          sessionData: {
            pagesVisited: ["/"],
            timeOnSite: 45,
            scrollDepth: 20,
          },
        },
      },
      {
        id: 3,
        name: "ProductLadder - Individual Build 1hr",
        description: "User selects Individual → Build → 1hr commitment on main page",
        source: "product-ladder",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "CTO",
          selectedProgram: "build",
          commitmentLevel: "1hr",
          audienceType: "individual",
          pathType: "build",
          sessionData: {
            pagesVisited: ["/"],
            timeOnSite: 180,
            scrollDepth: 90,
          },
        },
      },
      {
        id: 4,
        name: "ProductLadder - Individual Orchestrate 4wk",
        description: "User selects Individual → Orchestrate → 4wk commitment on main page",
        source: "product-ladder",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "CFO",
          selectedProgram: "orchestrate",
          commitmentLevel: "4wk",
          audienceType: "individual",
          pathType: "orchestrate",
          sessionData: {
            pagesVisited: ["/"],
            timeOnSite: 240,
            scrollDepth: 85,
          },
        },
      },
      {
        id: 5,
        name: "ProductLadder - Individual Build 90d",
        description: "User selects Individual → Build → 90d commitment on main page",
        source: "product-ladder",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "VP Product",
          selectedProgram: "build",
          commitmentLevel: "90d",
          audienceType: "individual",
          pathType: "build",
          sessionData: {
            pagesVisited: ["/"],
            timeOnSite: 300,
            scrollDepth: 95,
          },
        },
      },
      {
        id: 6,
        name: "ProductLadder - Team 3hr",
        description: "User selects Team → 3hr commitment on main page",
        source: "product-ladder",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "VP Engineering",
          selectedProgram: "team",
          commitmentLevel: "3hr",
          audienceType: "team",
          sessionData: {
            pagesVisited: ["/"],
            timeOnSite: 200,
            scrollDepth: 80,
          },
        },
      },
      {
        id: 7,
        name: "ProductLadder - Team 4wk",
        description: "User selects Team → 4wk commitment on main page",
        source: "product-ladder",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "Chief Operating Officer",
          selectedProgram: "team",
          commitmentLevel: "4wk",
          audienceType: "team",
          sessionData: {
            pagesVisited: ["/"],
            timeOnSite: 280,
            scrollDepth: 88,
          },
        },
      },
      {
        id: 8,
        name: "ProductLadder - Team 90d",
        description: "User selects Team → 90d commitment on main page",
        source: "product-ladder",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "Chief Strategy Officer",
          selectedProgram: "team",
          commitmentLevel: "90d",
          audienceType: "team",
          sessionData: {
            pagesVisited: ["/"],
            timeOnSite: 350,
            scrollDepth: 92,
          },
        },
      },
      {
        id: 9,
        name: "Individual Page - Build 1hr",
        description: "User on /individual page, selects Build → 1hr, clicks CTA",
        source: "individual-page",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "Product Manager",
          selectedProgram: "build",
          commitmentLevel: "1hr",
          audienceType: "individual",
          pathType: "build",
          sessionData: {
            pagesVisited: ["/", "/individual"],
            timeOnSite: 150,
            scrollDepth: 60,
          },
        },
      },
      {
        id: 10,
        name: "Individual Page - Build 4wk",
        description: "User on /individual page, selects Build → 4wk, clicks CTA",
        source: "individual-page",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "Senior Product Manager",
          selectedProgram: "build",
          commitmentLevel: "4wk",
          audienceType: "individual",
          pathType: "build",
          sessionData: {
            pagesVisited: ["/", "/individual"],
            timeOnSite: 220,
            scrollDepth: 70,
          },
        },
      },
      {
        id: 11,
        name: "Individual Page - Orchestrate 90d",
        description: "User on /individual page, selects Orchestrate → 90d, clicks CTA",
        source: "individual-page",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "Board Member",
          selectedProgram: "orchestrate",
          commitmentLevel: "90d",
          audienceType: "individual",
          pathType: "orchestrate",
          sessionData: {
            pagesVisited: ["/", "/individual"],
            timeOnSite: 380,
            scrollDepth: 85,
          },
        },
      },
      {
        id: 12,
        name: "Team Page - 3hr",
        description: "User on /team page, selects 3hr, clicks CTA",
        source: "team-page",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "Head of Engineering",
          selectedProgram: "team",
          commitmentLevel: "3hr",
          audienceType: "team",
          sessionData: {
            pagesVisited: ["/", "/team"],
            timeOnSite: 160,
            scrollDepth: 55,
          },
        },
      },
      {
        id: 13,
        name: "Team Page - 4wk",
        description: "User on /team page, selects 4wk, clicks CTA",
        source: "team-page",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "VP Operations",
          selectedProgram: "team",
          commitmentLevel: "4wk",
          audienceType: "team",
          sessionData: {
            pagesVisited: ["/", "/team"],
            timeOnSite: 250,
            scrollDepth: 75,
          },
        },
      },
      {
        id: 14,
        name: "Team Page - 90d",
        description: "User on /team page, selects 90d, clicks CTA",
        source: "team-page",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "Chief Technology Officer",
          selectedProgram: "team",
          commitmentLevel: "90d",
          audienceType: "team",
          sessionData: {
            pagesVisited: ["/", "/team"],
            timeOnSite: 420,
            scrollDepth: 90,
          },
        },
      },
      {
        id: 15,
        name: "ConsultationBooking Component",
        description: "User uses ConsultationBooking component (e.g., on BuilderSprint page)",
        source: "consultation-booking",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "Founder",
          selectedProgram: "builder-sprint",
          sessionData: {
            pagesVisited: ["/", "/builder-sprint"],
            timeOnSite: 200,
            scrollDepth: 65,
          },
        },
      },
      {
        id: 16,
        name: "FloatingBookCTA (Mobile)",
        description: "User clicks floating CTA on mobile after scrolling",
        source: "floating-cta",
        body: {
          name: "Krish Raja",
          email: "krish@tesla.com",
          jobTitle: "Mobile User",
          selectedProgram: "not-sure",
          sessionData: {
            pagesVisited: ["/"],
            timeOnSite: 180,
            scrollDepth: 50,
          },
        },
      },
    ];

    let stats = { total: 0, success: 0, failed: 0 };

    function updateStats() {
      document.getElementById('total').textContent = stats.total;
      document.getElementById('success').textContent = stats.success;
      document.getElementById('failed').textContent = stats.failed;
    }

    function createTestScenario(scenario) {
      const div = document.createElement('div');
      div.className = 'test-scenario';
      div.innerHTML = `
        <h3>[${scenario.id}] ${scenario.name}</h3>
        <p>${scenario.description}</p>
        <p><strong>Source:</strong> ${scenario.source}</p>
        <button onclick="testScenario(${scenario.id})" id="btn-${scenario.id}">Send Test Email</button>
        <div id="status-${scenario.id}" class="status" style="display: none;"></div>
      `;
      return div;
    }

    window.testScenario = async function(id) {
      const scenario = testScenarios.find(s => s.id === id);
      if (!scenario) return;

      const btn = document.getElementById(`btn-${id}`);
      const statusDiv = document.getElementById(`status-${id}`);
      
      btn.disabled = true;
      statusDiv.style.display = 'block';
      statusDiv.className = 'status pending';
      statusDiv.textContent = 'Sending...';
      stats.total++;
      updateStats();

      try {
        const { data, error } = await supabase.functions.invoke('send-lead-email', {
          body: scenario.body,
        });

        if (error) {
          throw error;
        }

        statusDiv.className = 'status success';
        statusDiv.textContent = `✅ Success! Email sent. Response: ${JSON.stringify(data)}`;
        stats.success++;
        updateStats();
      } catch (err) {
        statusDiv.className = 'status error';
        statusDiv.textContent = `❌ Error: ${err.message || JSON.stringify(err)}`;
        stats.failed++;
        updateStats();
      } finally {
        btn.disabled = false;
      }
    };

    // Render all test scenarios
    const container = document.getElementById('test-scenarios');
    testScenarios.forEach(scenario => {
      container.appendChild(createTestScenario(scenario));
    });

    updateStats();
  </script>
</body>
</html>
